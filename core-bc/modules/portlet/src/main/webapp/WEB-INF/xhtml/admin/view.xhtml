<?xml version="1.0" encoding="UTF-8"?>

<f:view xmlns="http://www.w3.org/1999/xhtml"
        xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
        xmlns:p="http://primefaces.org/ui" xmlns:ui="http://java.sun.com/jsf/facelets">

    <h:head/>

    <link href="#{request.contextPath}/css/wwwprv.css" rel="stylesheet" type="text/css"/>

    <div class="portlet-content-wrapper">
        <h:form id="theForm" onkeypress="javascript:formKeyPress(event);">

            <p:remoteCommand name="toggleSupplierChooser" actionListener="#{adminBackingBean.toggleSupplierChooser()}"/>

            <p:growl autoUpdate="true" sticky="false" />

            <h1>Administration</h1>

            <section>
                <h2>Användare med rollen "Filuppladdare"</h2>

                 <h:panelGroup layout="block" styleClass="portlet-msg-success" rendered="#{not empty adminBackingBean.userMessage}">#{adminBackingBean.userMessage}</h:panelGroup>

                 <h:panelGroup id="userTable">
                    <table>
                        <thead>
                        <tr>
                            <td>Namn</td>
                            <td>Leverantör</td>
                        </tr>
                        </thead>
                        <tbody>
                        <ui:repeat value="#{adminBackingBean.allUsers}" var="userContainer">
                            <tr>
                                <td>#{userContainer.liferayUser.fullName}</td>
                                <td>
                                    <div class="chosen-suppliers" data-userid="#{userContainer.dataPrivataUser.liferayUserId}">
                                        <h:commandLink class="toggle-choose-suppliers #{adminBackingBean.showSupplierChooser(userContainer) ? 'expanded' : ''}" value="#{utilBean.chosenSupplierString(userContainer)}">
                                            <f:ajax execute="" render=""/>
                                        </h:commandLink>

                                        <div class="supplier-chooser" style="#{adminBackingBean.showSupplierChooser(userContainer) ? '' : 'display: none;'}">

                                            <ui:repeat value="#{adminBackingBean.allSuppliers}"
                                                       var="supplier">
                                                <div class="supplier-select">
                                                    <h:selectBooleanCheckbox value="#{adminBackingBean.getUserWithSuppliersHelper()[userContainer][supplier]}">
                                                        <f:ajax render="@form"
                                                                listener="#{adminBackingBean.toggleSupplier(userContainer, supplier)}" onevent="reinitAfterPageUpdate"/>
                                                    </h:selectBooleanCheckbox>
                                                    #{supplier.enhetsKod}
                                                </div>
                                            </ui:repeat>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </ui:repeat>
                        </tbody>
                    </table>
                </h:panelGroup>
            </section>

            <section>
                <h2>Leverantörer</h2>

                <h:panelGroup layout="block" styleClass="portlet-msg-success" rendered="#{not empty adminBackingBean.supplierMessage}">#{adminBackingBean.supplierMessage}</h:panelGroup>

                <h:panelGroup id="supplierTable">
                    <table>
                        <thead>
                        <tr>
                            <td>Enhetskod</td>
                            <td>Enhetsnamn</td>
                            <td>Ansvarigt kansli</td>
                        </tr>
                        </thead>
                        <tbody>
                        <ui:repeat value="#{adminBackingBean.allSuppliers}" var="supplier">
                            <tr>
                                <td>
                                    <p:inplace editor="true" emptyLabel="Ej angiven">
                                        <h:inputText value="#{supplier.enhetsKod}" onchange="javascript:showSaveButton(this);"/>
                                    </p:inplace>
                                </td>
                                <td>
                                    <p:inplace editor="true" emptyLabel="Ej angiven">
                                        <h:inputText value="#{supplier.enhetsNamn}" onchange="javascript:showSaveButton(this);"/>
                                    </p:inplace>
                                </td>
                                <td>
                                    <!--#{supplier.ansvarigtKansli}-->
                                    <p:inplace editor="true" emptyLabel="Ej angiven">
                                        <h:selectOneMenu value="#{supplier.ansvarigtKansli}" onchange="javascript:showSaveButton(this);">
                                            <f:selectItem itemLabel="Välj..." itemValue=""/>
                                            <f:selectItem itemLabel="Borås" itemValue="Borås"/>
                                            <f:selectItem itemLabel="Göteborg" itemValue="Göteborg"/>
                                            <f:selectItem itemLabel="Mariestad" itemValue="Mariestad"/>
                                            <f:selectItem itemLabel="Uddevalla" itemValue="Uddevalla"/>
                                        </h:selectOneMenu>
                                    </p:inplace>
                                </td>
                                <td>
                                    <h:commandLink styleClass="save-link" style="display: none;" value="Spara">
                                        <f:ajax listener="#{adminBackingBean.saveSupplier(supplier)}"
                                                execute=":theForm:supplierTable" render="@form" onevent="reinitAfterPageUpdate"/>
                                    </h:commandLink>
                                </td>
                                <td>
                                    <h:commandLink value="Ta bort">
                                        <f:ajax listener="#{adminBackingBean.removeSupplier(supplier)}"
                                                execute=":theForm:supplierTable" render="@form" onevent="reinitAfterPageUpdate"/>
                                    </h:commandLink>
                                </td>
                            </tr>
                        </ui:repeat>
                        <tr class="label">
                            <td>Lägg till leverantör:</td>
                        </tr>
                        <tr>
                            <td>
                                <h:inputText value="#{adminBackingBean.supplierToAdd.enhetsKod}"/>
                            </td>
                            <td>
                                <h:inputText value="#{adminBackingBean.supplierToAdd.enhetsNamn}"/>
                            </td>
                            <td>
                                <h:selectOneMenu value="#{adminBackingBean.supplierToAdd.ansvarigtKansli}">
                                    <f:selectItem itemLabel="Välj..." itemValue="#{null}"/>
                                    <f:selectItem itemLabel="Borås" itemValue="Borås"/>
                                    <f:selectItem itemLabel="Göteborg" itemValue="Göteborg"/>
                                    <f:selectItem itemLabel="Mariestad" itemValue="Mariestad"/>
                                    <f:selectItem itemLabel="Uddevalla" itemValue="Uddevalla"/>
                                </h:selectOneMenu>
                            </td>
                            <td>
                                <h:commandButton value="Lägg till">
                                    <f:ajax execute="supplierTable" listener="#{adminBackingBean.addSupplier}"
                                            render="@form" onevent="reinitAfterPageUpdate"/>
                                </h:commandButton>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </h:panelGroup>
            </section>

        </h:form>

        <script type="application/javascript">

            initPage();

            function reinitAfterPageUpdate(data) {
                if (data.status='complete') {
                    initPage();
                }
            }

            function initPage() {
                var chooseSuppliersTrigger = $('.toggle-choose-suppliers');
                chooseSuppliersTrigger.on('click', function (e) {
                    var chosenSuppliersDiv = $(e.target).parent();
                    chosenSuppliersDiv.find('.supplier-chooser').slideToggle(200);
                    var toggleLink = chosenSuppliersDiv.find('.toggle-choose-suppliers');
                    toggleLink.toggleClass('expanded');

                    var userId = chosenSuppliersDiv.closest('.chosen-suppliers').attr('data-userid');
                    toggleSupplierChooser([{name: 'userId', value: userId}, {name: 'isExpanded', value: toggleLink.hasClass('expanded')}]); /* Primefaces remoteCommand */
                });

                /* Catch enter-press. */
                formKeyPress = function(event) {
                    if (event.keyCode == 13) {
                        event.returnValue = false; /* IE8 */
                        if (event.preventDefault) {
                            event.preventDefault();
                        }

                        var submitButton = $(event.target).closest('tr').find('input[type=submit]');

                        if (submitButton) {
                            submitButton.click();
                        }
                        return false;
                    }
                };
            }

            function showSaveButton(element) {
                $(element).closest('tr').find('.save-link').fadeIn(200);
            }

        </script>
    </div>

</f:view>
